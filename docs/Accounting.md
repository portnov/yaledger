# Используемые принципы бухгалтерского учёта

## Проводки и полупроводки

Входной файл состоит из записей. Каждая запись может порождать несколько
транзакций. Транзакция может порождать проводку.

Проводка — это запись о переносе части средств с одного счёта (или нескольких) на другой (или несколько других). Проводка состоит из следующих частей:

-   Кредит. Одна или несколько кредитовых полупроводок.
-   Дебет. Одна или несколько дебетовых полупроводок.
-   Курсовая разница. Либо отсутствует, либо представлена одной
    кредитовой полупроводкой, либо одной или несколькими дебетовыми
    полупроводками.

Полупроводка — это запись на одном счёте о зачислении или списании с него части средств. Полупроводка определяется следующими параметрами:

-   Тип: кредитовая или дебетовая.
-   Сумма. До обработки проводки суммы могут быть в произвольных
    валютах; после обработки проводки каждая полупроводка содержит сумму
    в валюте соответствующего счёта.
-   Счёт.

Проводки, загруженные из входного файла, но ещё не обработанные, могут
быть не согласованы (кредит не сходится с дебетом). Кроме того, они не
содержат курсовой разницы. В необработанных проводках хранятся суммы в
исходных валютах, которые могут не совпадать с валютами счетов.

При обработке проводки:

-   Проверяется, является ли проводка согласованной (кредит == дебет).
-   Если нет, то в проводку добавляется кредитовая или дебетовая
    полупроводка. Эта полупроводка создаётся по
    [автоматически найденному корреспондирующему счёту][Correspondence].
    При поиске счёта для выполнения дебетовой полупроводки
    может оказаться, что для счёта необходимо выполнить
    [автоматическое перенаправление части дебета][DebitRedirect]; в
    таком случае вместо одной дебетовой полупроводки будет создано
    несколько.
-   Суммы в полупроводках приводятся к валютам соответствующих счетов и
    округляются до точности валюты (то есть, например, до копеек).
-   Если в результате округления оказалось, что одна из частей проводки
    — ноль, и вторая часть состоит из единственной полупроводки, то эта
    вторая часть тоже обнуляется.
-   Вычисляется курсовая разница. В проводку добавляются соответствующие
    полупроводки. **NB:** курсовая разница вычисляется по текущим курсам
    валют. Т.к. позже курсы могут поменяться, то при подведении итогов в
    отчётах может образоваться дополнительная курсовая разница.

Таким образом, после обработки проводка:

-   Является согласованной.
-   Хранит суммы в валютах соответствующих счетов.

## Счета

Каждый счёт ведётся в определённой валюте. Счёт хранит:

-   Историю дебетовых полупроводок (только для дебетовых и свободных
    счетов).
-   Историю кредитовых полупроводок (только для кредитовых и свободных
    счетов).
-   Историю балансов. Хранятся как доступные, так и финансовые балансы (см. ниже).

## Резервы (холды)

На счетах могут быть создаваться резервы — записи о том, что какая-то сумма может быть впоследствии списана со счёта или записана на него. Резервы бывают дебетовые и кредитовые. Кредитовые счета могут содержать только кредитовые резервы, дебетовые счета — только дебетовые резервы, свободные счета — оба типа резервов.

Резерв создаётся на счету при помощи отдельной записи. Закрыт резерв может быть явно (отдельной записью) либо неявно, при использовании резерва полупроводкой. Более подробно см. на странице [Резервы][Holds].

Балансы счета вычисляются следующим образом:

* Доступный остаток = Баланс - Дебетовые холды
* Финансовый остаток = Баланс + Кредитовые холды

## Курсы валют

При обработке каждой проводки используются действующие на дату проводки
курсы валют. По этим же курсам вычисляется курсовая разница.

При подведении итогов в отчётах используются курсы валют, действующие на
конец отчётного периода.

В результате, если отчёт строится по длительному периоду, за который
курсы валют несколько раз менялись, то может образоваться неучтённая
курсовая разница (она будет видна как суммарное сальдо по корневой
группе — без курсовой разницы это всегда ноль). В то же время, если
отчёты строить по более мелким периодам, например, `--daily` или
`--weekly`, то в каждом из отчётов никакой неучтённой курсовой разницы
не будет.

[Correspondence]: Correspondence.md
[DebitRedirect]: DebitRedirect.md
[Holds]: Holds.md
