# Обработка дублированных записей

Если записи загружаются из нескольких файлов, то среди них могут
оказаться дублированные (например, одну запись загрузили из csv и из
default.yaledger). Причём дублирование может быть неполным. Например,
если данные получаем в виде CSV из телебанка, то может быть разница в
дате (транзакция прошла позже самой покупки). Если запись делали не по
чеку, а по памяти, то запись, полученная из телебанка, может содержать
немного другую сумму.

YaLedger поддерживает обработку дублированных записей. Такая обработка
настраивается параметром `deduplicate:` в yaledger.yaml. Параметр
содержит список правил. Каждое правило содержит:

-   new — условия применимости правила. Задаётся набор
    [атрибутов][Attributes], которые имеют записи, к которым
    применяется правило. Например, `{category: "purchase"}` — искать
    дубликаты только для транзакций, у которых атрибут category равен
    “purchase”.
-   old — среди каких транзакций искать дубликаты. Задаётся набор
    атриубутов, которые имеют записи, среди которых надо искать
    дубликаты. По умолчанию — дубликаты ищутся среди всех записей.
-   check-attributes — список атрибутов, совпадение которых нужно
    проверять. Следующие атрибуты имеют специальное значение:
    -   date. Проверяет совпадение дат. Может быть задано в виде
        словаря: `{date: 2}`. Значение определяет максимальное
        расхождение между датами транзакций. Например, в последнем
        примере — даты могут различаться на два дня. По умолчанию — даты
        должны совпадать (с точностью до суток).
    -   amount. Проверяет совпадение сумм транзакций. Может быть задано
        в виде словаря: `{amount: 5}`. Значение определяет максимальное
        расхождение между суммами, в процентах. По умолчанию — суммы
        должны совпадать.
    -   credit-account, debit-account. Проверяет соответственно
        совпадение кредитных, дебетных счетов.
    -   Остальные атрибуты задают проверку совпадения соответствующих
        атрибутов транзакций. Например, запись
        `check-attributes: [amount, {date: 1}, credit-account, category]`
        определяет, что суммы и кредитные счета транзакций должны
        совпадать, даты могут отличаться на 1 день, а также должен
        совпадать атрибут category.

-   action — действие при обнаружении дублирующихся транзакций.
    Возможные значения:
    -   error — выдать ошибку и прекратить работу.
    -   warning — выдать предупреждение и работать дальше.
    -   duplicate — оставить дублирующую транзакцию как есть.
    -   ignore-new — игнорировать новую транзакцию.
    -   delete-old — удалить старую транзакцию, оставить новую.
    -   set-attributes — новую транзакцию игнорировать, но для старой
        установить значения атрибутов на основе атрибутов новой
        транзакции. Атрибуты задаются в виде словаря. Ключ словаря
        определяет устанавливаемый атрибут, значение — устанавливаемое
        значение атрибута.

При использовании варианта set-attributes атрибут date задаёт установку
даты транзакции.

Устанавливаемые значения атрибутов могут задаваться следующим образом:

-   attribute: $name — установить значение атрибута старой транзакции
    attribute, равное значению параметра новой транзакции name.
-   attribute: ?name — аналогично предыдущему, но значение параметра
    attribute будет необязательным.
-   attribute: value — установить значение параметра attribute равным
    строке “value”.

Пример:

~~~ { .yaml }
deduplicate:
  - new: {category: purchase}
    # Проверять совпадение дат и счетов; суммы могут отличаться на 5%.
    "check-attributes": [ date, {amount: 5}, "credit-account", "debit-account" ]
    # Оставлять только новую транзакцию
    action: delete-old

  - new: {description: /Выдача наличных в банкомате/ }
    # Искать дубликаты только среди записей с данным атрибутом:
    old: {category: коммунальные}
    # Должны совпадать дата и сумма
    "check-attributes": [ amount, date ]
    # Оставлять только старую транзакцию
    action: ignore-new

  - new: {category: one}
    # Проверять совпадение сумм и счетов. Даты могут различаться на 1 день.
    "check-attributes": [ amount, "credit-account", "debit-account", {date: 1} ]
    # Установить атрибуты старой транзакции
    action:
      "set-attributes":
        cleared: ?date
~~~

[Attributes]: Attributes.md
